

<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>1. 前言 &mdash; 杰理OTA升级开发文档(iOS) v2.4.0 文档</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="https://doc.zh-jieli.com/Apps/static/css/custom.css" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=873fbbe3"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../_static/translations.js?v=beaddf03"></script>
      <script src="https://doc.zh-jieli.com/Apps/static/js/custom.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜索" href="../search.html" />
    <link rel="next" title="开源社区" href="contactUs.html" />
    <link rel="prev" title="测试调试" href="debug.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html">
            
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="搜索文档" aria-label="搜索文档" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="导航菜单">
              <p class="caption" role="heading"><span class="caption-text">开发框架</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Framework/framework.html">SDK架构</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">工程介绍</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../resource/sdk_structure.html">SDK开发包介绍</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">开发说明</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Development/Content/import.html">1.项目配置</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Development/Content/function_desc.html">2.使用自定义的蓝牙连接API进行OTA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Development/Content/api_desc.html">3.使用JL_BLEKit.xcframework蓝牙连接方式</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Development/Content/API/api_docs.html">4. API 说明</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">其他</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="debug.html">测试调试</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">1. 前言</a></li>
<li class="toctree-l1"><a class="reference internal" href="#id2">2. 常见问题</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id3">2.1. 自定义蓝牙接入时，如何使用设备的广播包信息？</a></li>
<li class="toctree-l2"><a class="reference internal" href="#ble-ble">2.2. 为什么BLE握手认证执行了两次或者多次，导致BLE握手失败？</a></li>
<li class="toctree-l2"><a class="reference internal" href="#ota">2.3. 为什么OTA升级结束但升级结果是失败？</a></li>
<li class="toctree-l2"><a class="reference internal" href="#appancs">2.4. APP断开重连ANCS设备，回连失败怎么处理？</a></li>
<li class="toctree-l2"><a class="reference internal" href="#ble">2.5. 升级过程出现BLE断开或者超时</a></li>
<li class="toctree-l2"><a class="reference internal" href="#app">2.6. 如何导出APP中的日志信息</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id4">2.7. OTA升级问题</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id5">2.7.1. 单备份升级</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id6">2.7.2. 单备份升级的步骤是什么？为什么要这么做？</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id7">2.7.3. 升级过程中可能会遇到的问题有那些？</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id8">问题1：第一阶段升级后，无法回连设备的问题</a></li>
<li class="toctree-l4"><a class="reference internal" href="#sdk">方案1：使用SDK的蓝牙连接方式</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id9">方案2：使用自定义蓝牙连接方式</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id10">2.7.4. 传输/校验/升级过程中断开的情况分析</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id11">传输过程中断开的可能原因</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id12">校验过程中断开的可能原因</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id13">升级过程中断开的可能原因</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id14">日志分析方法</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id15">2.7.5. 升级过程中可能出现的命令错误</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id16">命令错误类型分析</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id17">2.7.6. OTA 后台升级问题</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#ios">iOS 蓝牙后台权限配置</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id18">配置步骤</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id19">注意事项</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="contactUs.html">开源社区</a></li>
<li class="toctree-l1"><a class="reference internal" href="version.html">发布记录</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="移动版导航菜单" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">杰理OTA升级开发文档(iOS)</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="页面导航">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">1. 前言</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1><center><b>杰理OTA SDK<br/>常见问题答疑</b></center></h1>
<section id="id1">
<h1>1. 前言<a class="headerlink" href="#id1" title="Link to this heading"></a></h1>
<p>​	本文档主要记录比较经常遇到的问题，统一进行答疑，方便快速开发。开发者可以先检索已有的问题是否符合你遇到的问题；如果是新的问题，请按照以下步骤进行提问，我们将尽快解答。</p>
<p>描述问题的情况以及测试环境，请参考提问格式：</p>
<blockquote>
<div><p>提供打印日志，输出方式请参考<a class="reference external" href="https://doc.zh-jieli.com/Apps/iOS/ota/zh-cn/master/Other/debug.html#id1">测试调试</a>，最好可以提供现象截图或视频</p>
</div></blockquote>
<p>提问格式</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>问题描述: XXXXXX
测试环境: 固件: ACxxx_xxx_SDK_Vxxx   软件: JL_OTA_Vxxx
问题标签: SDK接入 资源更新(固件升级)  其他
复现步骤: 1. xxxx 2. xxxx 3.xxxx
复现概率: 必现, 1/20, n / m 
公版Demo是否复现: 是，否
问题出现时间段: yyyy/MM/dd hh:mm - yyyy/MM/dd hh:mm 例如: 2022/05/28 17:00 - 2022/05/28 17:02
备注: xxxx
</pre></div>
</div>
<p>重点: 开发前，请阅读<a class="reference external" href="https://doc.zh-jieli.com/Apps/iOS/ota/zh-cn/master/index.html#ota-ios">杰理OTA SDK开发文档 </a></p>
</section>
<section id="id2">
<h1>2. 常见问题<a class="headerlink" href="#id2" title="Link to this heading"></a></h1>
<section id="id3">
<h2>2.1. 自定义蓝牙接入时，如何使用设备的广播包信息？<a class="headerlink" href="#id3" title="Link to this heading"></a></h2>
<p>利用系统提供的搜索蓝牙设备接口，从回调中获取广播包信息操作如下：</p>
<div class="highlight-objective-c notranslate"><div class="highlight"><pre><span></span><span class="p">-(</span><span class="kt">void</span><span class="p">)</span><span class="nf">centralManager:</span><span class="p">(</span><span class="bp">CBCentralManager</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="nv">central</span>
<span class="nl">didDiscoverPeripheral</span><span class="p">:(</span><span class="bp">CBPeripheral</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="nv">peripheral</span>
<span class="w">    </span><span class="nl">advertisementData</span><span class="p">:(</span><span class="bp">NSDictionary</span><span class="o">&lt;</span><span class="bp">NSString</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="kt">id</span><span class="o">&gt;</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="nv">advertisementData</span>
<span class="w">                 </span><span class="nl">RSSI</span><span class="p">:(</span><span class="bp">NSNumber</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="nv">RSSI</span>
<span class="p">{</span>
<span class="w">    </span><span class="bp">NSString</span><span class="w"> </span><span class="o">*</span><span class="n">ble_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">advertisementData</span><span class="p">[</span><span class="s">@&quot;kCBAdvDataLocalName&quot;</span><span class="p">];</span>
<span class="w">    </span><span class="c1">//NSLog(@&quot;---&gt; Found Name:%@ Rssi:%@&quot;,ble_name,RSSI);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ble_name</span><span class="p">.</span><span class="n">length</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span>
<span class="w">    </span><span class="bp">NSData</span><span class="w"> </span><span class="o">*</span><span class="n">ble_AD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">advertisementData</span><span class="p">[</span><span class="s">@&quot;kCBAdvDataManufacturerData&quot;</span><span class="p">];</span>
<span class="w">    </span><span class="bp">NSDictionary</span><span class="w"> </span><span class="o">*</span><span class="n">info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">JL_BLEAction</span><span class="w"> </span><span class="n">bluetoothKey_1</span><span class="o">:</span><span class="n">_filterKey</span><span class="w"> </span><span class="n">Filter</span><span class="o">:</span><span class="n">advertisementData</span><span class="p">];</span>
<span class="w">    </span><span class="bp">NSString</span><span class="w"> </span><span class="o">*</span><span class="n">ble_addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">JL_BLEAction</span><span class="w"> </span><span class="n">otaBleMacAddressFromCBAdvDataManufacturerData</span><span class="o">:</span><span class="n">ble_AD</span><span class="p">];</span>
<span class="w">    </span><span class="cm">/*--- 过滤蓝牙设备 ---*/</span>
<span class="w">    </span><span class="kt">BOOL</span><span class="w"> </span><span class="n">isOk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">info</span><span class="p">[</span><span class="s">@&quot;ISOK&quot;</span><span class="p">]</span><span class="w"> </span><span class="n">boolValue</span><span class="p">];</span>
<span class="w">    </span><span class="c1">//设备类型</span>
<span class="w">    </span><span class="n">JL_DeviceType</span><span class="w"> </span><span class="n">deviceType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">info</span><span class="p">[</span><span class="s">@&quot;TYPE&quot;</span><span class="p">]</span><span class="w"> </span><span class="n">intValue</span><span class="p">];</span>

<span class="w">    </span><span class="c1">//转换成JL_EntityM对象</span>
<span class="w">    </span><span class="bp">NSMutableDictionary</span><span class="w"> </span><span class="o">*</span><span class="n">mDic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="bp">NSMutableDictionary</span><span class="w"> </span><span class="n">new</span><span class="p">];</span>
<span class="w">    </span><span class="p">[</span><span class="n">mDic</span><span class="w"> </span><span class="n">setObject</span><span class="o">:</span><span class="n">peripheral</span><span class="w"> </span><span class="n">forKey</span><span class="o">:</span><span class="s">@&quot;BLE&quot;</span><span class="p">];</span>
<span class="w">    </span><span class="p">[</span><span class="n">mDic</span><span class="w"> </span><span class="n">setObject</span><span class="o">:</span><span class="n">rssi</span><span class="w">       </span><span class="n">forKey</span><span class="o">:</span><span class="s">@&quot;RSSI&quot;</span><span class="p">];</span>
<span class="w">    </span><span class="p">[</span><span class="n">mDic</span><span class="w"> </span><span class="n">setObject</span><span class="o">:</span><span class="n">info</span><span class="o">?:</span><span class="l">@{}</span><span class="w">  </span><span class="n">forKey</span><span class="o">:</span><span class="s">@&quot;INFO&quot;</span><span class="p">];</span>
<span class="w">    </span><span class="n">JL_EntityM</span><span class="w"> </span><span class="o">*</span><span class="n">entity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">JL_EntityM</span><span class="w"> </span><span class="n">changeToEntity</span><span class="o">:</span><span class="n">mDic</span><span class="p">];</span>
<span class="p">}</span>
</pre></div>
</div>
<p>当完成转换时，即可获得以下的属性值</p>
<div class="highlight-objective-c notranslate"><div class="highlight"><pre><span></span><span class="w"> </span>
<span class="k">@property</span><span class="p">(</span><span class="k">strong</span><span class="p">,</span><span class="k">nonatomic</span><span class="p">)</span><span class="w"> </span><span class="bp">NSString</span><span class="w">        </span><span class="o">*</span><span class="n">mUUID</span><span class="p">;</span>
<span class="k">@property</span><span class="p">(</span><span class="k">strong</span><span class="p">,</span><span class="k">nonatomic</span><span class="p">)</span><span class="w"> </span><span class="bp">NSNumber</span><span class="w">        </span><span class="o">*</span><span class="n">mRSSI</span><span class="p">;</span>
<span class="k">@property</span><span class="p">(</span><span class="k">readonly</span><span class="p">,</span><span class="k">copy</span><span class="p">,</span><span class="k">nonatomic</span><span class="p">)</span><span class="bp">NSString</span><span class="w">  </span><span class="o">*</span><span class="n">mItem</span><span class="p">;</span>
<span class="cm">/**</span>
<span class="cm"> * mType值说明：</span>
<span class="cm"> *  -1：传统设备</span>
<span class="cm"> *  0：AI音箱</span>
<span class="cm"> *  1：TWS</span>
<span class="cm"> *  2：数码充电仓</span>
<span class="cm"> *  3：普通耳机</span>
<span class="cm"> *  4：声卡类型</span>
<span class="cm"> *  5：手表类型</span>
<span class="cm"> */</span>
<span class="k">@property</span><span class="p">(</span><span class="k">assign</span><span class="p">,</span><span class="k">nonatomic</span><span class="p">)</span><span class="w"> </span><span class="n">JL_DeviceType</span><span class="w">   </span><span class="n">mType</span><span class="p">;</span>
<span class="k">@property</span><span class="p">(</span><span class="k">assign</span><span class="p">,</span><span class="k">nonatomic</span><span class="p">)</span><span class="w"> </span><span class="kt">BOOL</span><span class="w">            </span><span class="n">isExclusive</span><span class="p">;</span>
<span class="k">@property</span><span class="p">(</span><span class="k">assign</span><span class="p">,</span><span class="k">nonatomic</span><span class="p">)</span><span class="w"> </span><span class="kt">BOOL</span><span class="w">            </span><span class="n">isBound</span><span class="p">;</span>
<span class="k">@property</span><span class="p">(</span><span class="k">assign</span><span class="p">,</span><span class="k">nonatomic</span><span class="p">)</span><span class="w"> </span><span class="kt">BOOL</span><span class="w">            </span><span class="n">isEdrLinked</span><span class="p">;</span>
<span class="k">@property</span><span class="p">(</span><span class="k">assign</span><span class="p">,</span><span class="k">nonatomic</span><span class="p">)</span><span class="w"> </span><span class="kt">BOOL</span><span class="w">            </span><span class="n">isCharging</span><span class="p">;</span>
<span class="k">@property</span><span class="p">(</span><span class="k">assign</span><span class="p">,</span><span class="k">nonatomic</span><span class="p">)</span><span class="w"> </span><span class="kt">BOOL</span><span class="w">            </span><span class="n">isCharging_L</span><span class="p">;</span>
<span class="k">@property</span><span class="p">(</span><span class="k">assign</span><span class="p">,</span><span class="k">nonatomic</span><span class="p">)</span><span class="w"> </span><span class="kt">BOOL</span><span class="w">            </span><span class="n">isCharging_R</span><span class="p">;</span>
<span class="k">@property</span><span class="p">(</span><span class="k">assign</span><span class="p">,</span><span class="k">nonatomic</span><span class="p">)</span><span class="w"> </span><span class="kt">BOOL</span><span class="w">            </span><span class="n">isCharging_C</span><span class="p">;</span>
<span class="k">@property</span><span class="p">(</span><span class="k">assign</span><span class="p">,</span><span class="k">nonatomic</span><span class="p">)</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w">         </span><span class="n">mPower</span><span class="p">;</span>
<span class="k">@property</span><span class="p">(</span><span class="k">assign</span><span class="p">,</span><span class="k">nonatomic</span><span class="p">)</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w">         </span><span class="n">mPower_L</span><span class="p">;</span>
<span class="k">@property</span><span class="p">(</span><span class="k">assign</span><span class="p">,</span><span class="k">nonatomic</span><span class="p">)</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w">         </span><span class="n">mPower_R</span><span class="p">;</span>
<span class="k">@property</span><span class="p">(</span><span class="k">assign</span><span class="p">,</span><span class="k">nonatomic</span><span class="p">)</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w">         </span><span class="n">mPower_C</span><span class="p">;</span>
<span class="k">@property</span><span class="p">(</span><span class="k">strong</span><span class="p">,</span><span class="k">nonatomic</span><span class="p">)</span><span class="w"> </span><span class="bp">NSString</span><span class="w">        </span><span class="o">*</span><span class="n">mVID</span><span class="p">;</span>
<span class="k">@property</span><span class="p">(</span><span class="k">strong</span><span class="p">,</span><span class="k">nonatomic</span><span class="p">)</span><span class="w"> </span><span class="bp">NSString</span><span class="w">        </span><span class="o">*</span><span class="n">mPID</span><span class="p">;</span>
<span class="k">@property</span><span class="p">(</span><span class="k">strong</span><span class="p">,</span><span class="k">nonatomic</span><span class="p">)</span><span class="w"> </span><span class="bp">NSString</span><span class="w">        </span><span class="o">*</span><span class="n">mEdr</span><span class="p">;</span>
<span class="k">@property</span><span class="p">(</span><span class="k">strong</span><span class="p">,</span><span class="k">nonatomic</span><span class="p">)</span><span class="w"> </span><span class="bp">NSString</span><span class="w">        </span><span class="o">*</span><span class="n">mBleAddr</span><span class="p">;</span><span class="w">            </span><span class="c1">//OTA设备需要</span>
<span class="k">@property</span><span class="p">(</span><span class="k">assign</span><span class="p">,</span><span class="k">nonatomic</span><span class="p">)</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w">         </span><span class="n">mChipType</span><span class="p">;</span><span class="w">            </span><span class="c1">//0：690x 1：692x 2：693x</span>
<span class="k">@property</span><span class="p">(</span><span class="k">assign</span><span class="p">,</span><span class="k">nonatomic</span><span class="p">)</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w">         </span><span class="n">mProtocolType</span><span class="p">;</span><span class="w">        </span><span class="c1">//默认0x00</span>
<span class="cm">/**</span>
<span class="cm"> 0x00 - dismiss 不显示弹窗</span>
<span class="cm"> 0x01 - unconnected 经典蓝牙未连接</span>
<span class="cm">    iOS : 不显示电量，请手动连接XXX</span>
<span class="cm">    Android：不显示电量，显示连接按钮</span>
<span class="cm"> 0x02 - connected 经典蓝牙已连接</span>
<span class="cm">    iOS：判断已连接的经典蓝牙名是否一致，若未连接或蓝牙名不一致，</span>
<span class="cm">         显示“设备已被占用”。若一致，显示电量等信息。</span>
<span class="cm">    Android：判断已连接的经典蓝牙Mac是否一致，若未连接或蓝牙Mac不一致，</span>
<span class="cm">             显示“设备已被占用”。若一致，显示电量等信息。</span>
<span class="cm"> 0x03 - connecting 设备正在自动回连</span>
<span class="cm">    Android 和 iOS 显示“设备正在自动回连 ”</span>
<span class="cm"> 0x04 - connectionless 设备不可连接（需要按下配对按键）</span>
<span class="cm">    Android 和 iOS 显示配对操作方式</span>
<span class="cm"> */</span>
<span class="k">@property</span><span class="p">(</span><span class="k">assign</span><span class="p">,</span><span class="k">nonatomic</span><span class="p">)</span><span class="w"> </span><span class="kt">int8_t</span><span class="w">          </span><span class="n">mScene</span><span class="p">;</span>
<span class="k">@property</span><span class="p">(</span><span class="k">assign</span><span class="p">,</span><span class="k">nonatomic</span><span class="p">)</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w">         </span><span class="n">mSeq</span><span class="p">;</span><span class="w">                   </span><span class="c1">//Seq 每次开机会加 1，用于app区分是否同一次开机</span>
<span class="k">@property</span><span class="p">(</span><span class="k">assign</span><span class="p">,</span><span class="k">nonatomic</span><span class="p">)</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w">         </span><span class="n">mTWS_Paired</span><span class="p">;</span><span class="w">            </span><span class="c1">//TWS配对标识，0:未配对 1:已配对</span>
<span class="k">@property</span><span class="p">(</span><span class="k">assign</span><span class="p">,</span><span class="k">nonatomic</span><span class="p">)</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w">         </span><span class="n">mTWS_Cap</span><span class="p">;</span><span class="w">               </span><span class="c1">//0:关盖 1:开盖</span>
<span class="k">@property</span><span class="p">(</span><span class="k">assign</span><span class="p">,</span><span class="k">nonatomic</span><span class="p">)</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w">         </span><span class="n">mTWS_Mode</span><span class="p">;</span><span class="w">              </span><span class="c1">//0:充电模式 1:发射模式</span>
<span class="k">@property</span><span class="p">(</span><span class="k">assign</span><span class="p">,</span><span class="k">nonatomic</span><span class="p">)</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w">         </span><span class="n">mHeadsetMaster</span><span class="p">;</span><span class="w">         </span><span class="c1">//主从标识 (0:从机， 1:主机)</span>
<span class="k">@property</span><span class="p">(</span><span class="k">assign</span><span class="p">,</span><span class="k">nonatomic</span><span class="p">)</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w">         </span><span class="n">mHeadsetLinkEnable</span><span class="p">;</span><span class="w">     </span><span class="c1">//连接标识</span>
</pre></div>
</div>
<blockquote>
<div><p>这里部分属性值会根据设备类型来判断是否具备实际实用意义</p>
</div></blockquote>
</section>
<section id="ble-ble">
<h2>2.2. 为什么BLE握手认证执行了两次或者多次，导致BLE握手失败？<a class="headerlink" href="#ble-ble" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>设备必须固定有一个BLE服务号，和2两个读写特征值（分别是读和写），来实现数据交互。</p></li>
<li><p>目前SDK使用的默认服务号为AE00，写特征是AE01，读特征AE02，保证设备端有一组AE00、AE01、AE02且不能重复。</p></li>
<li><p>可以添加其他服务号和特征值，但不要与SDK正在使用的服务号和特征值名字重复。</p></li>
</ul>
</section>
<section id="ota">
<h2>2.3. 为什么OTA升级结束但升级结果是失败？<a class="headerlink" href="#ota" title="Link to this heading"></a></h2>
<p>参考结果提示：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/---</span> <span class="mh">0x01</span> <span class="n">升级数据校验失败</span> <span class="o">---/</span>
<span class="o">/---</span> <span class="mh">0x02</span> <span class="n">升级失败</span> <span class="o">---/</span>
<span class="o">/---</span> <span class="mh">0x03</span> <span class="n">加密Key不对</span> <span class="o">---/</span>
<span class="o">/---</span> <span class="mh">0x04</span> <span class="n">升级文件出错</span> <span class="o">---/</span>
<span class="o">/---</span> <span class="mh">0x05</span> <span class="n">uboot不匹配</span> <span class="o">---/</span>
<span class="o">/---</span> <span class="mh">0x06</span> <span class="n">升级过程长度出错</span> <span class="o">---/</span>
<span class="o">/---</span> <span class="mh">0x07</span> <span class="n">升级过程flash读写失败</span> <span class="o">---/</span>
<span class="o">/---</span> <span class="mh">0x08</span> <span class="n">升级过程指令超时</span> <span class="o">---/</span>
<span class="n">NSLog</span><span class="p">(</span><span class="o">@</span><span class="s2">&quot;【%@】OTA --&gt; Fail: </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">mBLE_NAME</span><span class="p">,</span><span class="n">otaSt</span><span class="p">);</span>

</pre></div>
</div>
<p>如果出错是0x03或者0x04，请确保固件升级文件是否设置了加密key；其他出错，如注释解析。
有其他问题疑问也可以将APP和固件端的log发给杰理。</p>
</section>
<section id="appancs">
<h2>2.4. APP断开重连ANCS设备，回连失败怎么处理？<a class="headerlink" href="#appancs" title="Link to this heading"></a></h2>
<p>1、ANCS设备连接APP就算APP断开BLE，但设备的BLE依然会与iPhone保持后台连接。那么此时在APP中搜索设备BLE是搜不到，需要用通过UUID回连设备，可以暂存上次连接时的UUID。</p>
<p>2、就算连接上了BLE握手配对失败如何处理？那么请将固件Log发送给我们的杰理OTA固件同事。</p>
<p><a class="reference external" href="https://www.jianshu.com/p/43836fd36595">ANCS参考资料</a></p>
</section>
<section id="ble">
<h2>2.5. 升级过程出现BLE断开或者超时<a class="headerlink" href="#ble" title="Link to this heading"></a></h2>
<p>此时APP的Log相当于停止在某个0xe5的命令之中：</p>
<blockquote>
<div><p>(GET)--&gt;JL_CMD Opcode:0xe5 SN:1 Reply:1 Param:(6)000000000200</p>
</div></blockquote>
<p>这种情况是固件端没有继续发0xe5命令来取数据（0xe5携带着seek和length，APP会根据这两参数从固件的升级文件里找到对应数据发回给设备）。</p>
<p>或者还伴随着BLE断开的打印，也请将App和固件Log发给杰理。</p>
</section>
<section id="app">
<h2>2.6. 如何导出APP中的日志信息<a class="headerlink" href="#app" title="Link to this heading"></a></h2>
<ol class="arabic simple">
<li><p>安装<a class="reference external" href="https://www.i4.cn/">爱思助手</a></p></li>
<li><p>手机连接电脑以及打开爱思助手</p></li>
</ol>
<p><img alt="image-20230210115224990" src="../_images/image-20230210115224990.png" /></p>
<ol class="arabic simple">
<li><p>按照步骤选中内容</p></li>
</ol>
<p><img alt="image-20230210115349379" src="../_images/image-20230210115349379.png" /></p>
<ol class="arabic simple" start="4">
<li><p>选中对应的日志，选择导出。</p></li>
</ol>
<p><img alt="image-20230210115441823" src="../_images/image-20230210115441823.png" /></p>
</section>
<section id="id4">
<h2>2.7. OTA升级问题<a class="headerlink" href="#id4" title="Link to this heading"></a></h2>
<section id="id5">
<h3>2.7.1. 单备份升级<a class="headerlink" href="#id5" title="Link to this heading"></a></h3>
<p><strong>问题：</strong> AC701N的单备份升级时，v1.6.3版本SDK接入时的内容细节是什么？</p>
<p><strong>解答：</strong> 由于OTA单备份升级涉及到一个断开回连的操作，所以需要在OTA的回调中处理一下，参考以下代码：</p>
<div class="highlight-objc notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">JL_OTAResultReconnectWithMacAddr</span><span class="p">){</span>
<span class="w">    </span><span class="p">[[</span><span class="n">JL_RunSDK</span><span class="w"> </span><span class="n">sharedMe</span><span class="p">]</span><span class="w"> </span><span class="n">setIsOTAFailRelink</span><span class="o">:</span><span class="nb">NO</span><span class="p">];</span>

<span class="w">    </span><span class="p">[</span><span class="nb">self</span><span class="w"> </span><span class="n">otaTimeCheck</span><span class="p">];</span><span class="w"> </span><span class="c1">// 增加超时检测</span>
<span class="w">    </span><span class="nb">self</span><span class="o">-&gt;</span><span class="n">_isOtaRelink</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">YES</span><span class="p">;</span>
<span class="w">    </span>
<span class="w">    </span><span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;---&gt; OTA 设备当前UUID... %@&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">self</span><span class="p">.</span><span class="n">otaUUID</span><span class="p">);</span>
<span class="w">    </span>
<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * 连接方案选择：</span>
<span class="cm">     * 1. 如果使用的是SDK提供的蓝牙连接方案，则需要在此处，调用搜索设备接口即可，</span>
<span class="cm">     *    库里面做了自动回连的流程，只是需要从这里激活一下它。</span>
<span class="cm">     *    [self.mBleMultiple scanStart];</span>
<span class="cm">     * </span>
<span class="cm">     * 2. 如果使用的自定义蓝牙连接方案，则可以详细参考以下的开源库。</span>
<span class="cm">     *    https://gitee.com/Jieli-Tech/iOS-JL_OTA</span>
<span class="cm">     */</span>
<span class="p">}</span>
</pre></div>
</div>
<p>回连上设备之后，需要继续获取设备的信息：</p>
<div class="highlight-objc notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">mBleEntityM</span><span class="p">.</span><span class="n">mCmdManager</span><span class="w"> </span><span class="n">cmdTargetFeatureResult</span><span class="o">:^</span><span class="p">(</span><span class="n">JL_CMDStatus</span><span class="w"> </span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">sn</span><span class="p">,</span><span class="w"> </span><span class="bp">NSData</span><span class="w"> </span><span class="n">_Nullable</span><span class="w"> </span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 判断状态，并再次进入OTA升级</span>
<span class="p">}];</span>
</pre></div>
</div>
</section>
<section id="id6">
<h3>2.7.2. 单备份升级的步骤是什么？为什么要这么做？<a class="headerlink" href="#id6" title="Link to this heading"></a></h3>
<p><strong>问题：</strong> 单备份升级的步骤是什么？为什么要这么做？</p>
<p><strong>解答：</strong></p>
<ul class="simple">
<li><p><strong>升级步骤：</strong> 单备份升级会被分为两部分：传输文件内容 + 校验升级内容</p></li>
<li><p><strong>操作流程：</strong> 需要先第一次进行内容传输，再次回连后进行升级</p></li>
<li><p><strong>技术原因：</strong> 因为设备的flash过小，无法一次性完全装载所有的升级文件内容</p></li>
</ul>
</section>
<section id="id7">
<h3>2.7.3. 升级过程中可能会遇到的问题有那些？<a class="headerlink" href="#id7" title="Link to this heading"></a></h3>
<section id="id8">
<h4>问题1：第一阶段升级后，无法回连设备的问题<a class="headerlink" href="#id8" title="Link to this heading"></a></h4>
<p><strong>解决方案：</strong> 检查升级步骤到了哪儿停止的，一般出现如下打印，是说明第一阶段已经升级完成，需要重新连接设备进行第二阶段的升级。</p>
<p><strong>典型日志输出：</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>2022-09-20 10:11:55.155658+0800 JL_OTA[64857:10204438] 【AC701N_WATCH】(SEND)--&gt;JL_CMD Opcode:0x b SN:6 Reply:1 Param:(2)0001 
2022-09-20 10:11:55.195791+0800 JL_OTA[64857:10204438] 【AC701N_WATCH】(GET)--&gt;JL_RSP Opcode:0x b SN:6 Status:0 Param:(1)01
2022-09-20 10:11:55.196640+0800 JL_OTA[64857:10204438] 【AC701N_WATCH】OTA --&gt; (APP relink type: JL_OTAResultReconnectWithMacAddr)
2022-09-20 10:11:55.310501+0800 JL_OTA[64857:10204438] BLE Disconnect ---&gt; Device AC701N_WATCH error:7
</pre></div>
</div>
<p><strong>重连注意事项：</strong> 设备的UUID已发生了改变，无法通过前一个UUID去回连设备，这时候分为两种情况：</p>
</section>
<section id="sdk">
<h4>方案1：使用SDK的蓝牙连接方式<a class="headerlink" href="#sdk" title="Link to this heading"></a></h4>
<ol class="arabic">
<li><p>再次执行搜索设备的方法：</p>
<div class="highlight-objc notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">mBleMultiple</span><span class="w"> </span><span class="n">scanContinue</span><span class="p">];</span><span class="w"> </span><span class="c1">// mBleMultiple为 JL_BLEMultiple 类对象</span>
</pre></div>
</div>
</li>
<li><p>当收到连接成功的回调后，再次请求查询设备状态：</p>
<div class="highlight-objc notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">mBleEntityM</span><span class="p">.</span><span class="n">mCmdManager</span><span class="w"> </span><span class="n">cmdTargetFeatureResult</span><span class="o">:^</span><span class="p">(</span><span class="n">JL_CMDStatus</span><span class="w"> </span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">sn</span><span class="p">,</span><span class="w"> </span><span class="bp">NSData</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">_Nullable</span><span class="w"> </span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 处理结果</span>
<span class="p">}];</span><span class="w"> </span><span class="c1">// mBleEntityM 为 JL_EntityM 类对象</span>
</pre></div>
</div>
</li>
</ol>
</section>
<section id="id9">
<h4>方案2：使用自定义蓝牙连接方式<a class="headerlink" href="#id9" title="Link to this heading"></a></h4>
<ol class="arabic">
<li><p>在收到 <code class="docutils literal notranslate"><span class="pre">JL_OTAResultReconnectWithMacAddr</span></code> 回调之后，执行扫描蓝牙设备的任务</p></li>
<li><p>通过匹配广播包信息的方式进行回连：</p>
<div class="highlight-objc notranslate"><div class="highlight"><pre><span></span><span class="c1">// OTA升级过程，回连使用</span>
<span class="k">if</span><span class="w"> </span><span class="p">([</span><span class="n">JL_BLEAction</span><span class="w"> </span><span class="n">otaBleMacAddress</span><span class="o">:</span><span class="nb">self</span><span class="p">.</span><span class="n">lastBleMacAddress</span><span class="w"> </span>
<span class="w">             </span><span class="nl">isEqualToCBAdvDataManufacturerData</span><span class="p">:</span><span class="n">ble_AD</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">[</span><span class="nb">self</span><span class="w"> </span><span class="n">connectBLE</span><span class="o">:</span><span class="n">peripheral</span><span class="p">];</span><span class="w"> </span><span class="c1">// 连接对应的蓝牙</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>之后请求查询设备状态：</p>
<div class="highlight-objc notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">mBleEntityM</span><span class="p">.</span><span class="n">mCmdManager</span><span class="w"> </span><span class="n">cmdTargetFeatureResult</span><span class="o">:^</span><span class="p">(</span><span class="n">JL_CMDStatus</span><span class="w"> </span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">sn</span><span class="p">,</span><span class="w"> </span><span class="bp">NSData</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">_Nullable</span><span class="w"> </span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 处理结果</span>
<span class="p">}];</span><span class="w"> </span><span class="c1">// mBleEntityM 为 JL_EntityM 类对象</span>
</pre></div>
</div>
</li>
</ol>
</section>
</section>
<section id="id10">
<h3>2.7.4. 传输/校验/升级过程中断开的情况分析<a class="headerlink" href="#id10" title="Link to this heading"></a></h3>
<section id="id11">
<h4>传输过程中断开的可能原因<a class="headerlink" href="#id11" title="Link to this heading"></a></h4>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>原因类别</p></th>
<th class="head"><p>具体原因</p></th>
<th class="head"><p>解决方案</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>设备电量</p></td>
<td><p>设备电量不足，导致设备关机</p></td>
<td><p>确保设备电量充足，建议电量&gt;30%</p></td>
</tr>
<tr class="row-odd"><td><p>信号问题</p></td>
<td><p>设备距离过远，导致信号不稳定</p></td>
<td><p>保持设备与手机距离在1米以内</p></td>
</tr>
<tr class="row-even"><td><p>设备异常</p></td>
<td><p>设备异常，导致设备重启</p></td>
<td><p>检查设备状态，必要时重启设备</p></td>
</tr>
<tr class="row-odd"><td><p>手机蓝牙</p></td>
<td><p>手机蓝牙异常，导致连接断开</p></td>
<td><p>重启手机蓝牙或重启手机</p></td>
</tr>
</tbody>
</table>
</section>
<section id="id12">
<h4>校验过程中断开的可能原因<a class="headerlink" href="#id12" title="Link to this heading"></a></h4>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>原因类别</p></th>
<th class="head"><p>具体原因</p></th>
<th class="head"><p>解决方案</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>设备电量</p></td>
<td><p>设备电量不足，导致设备关机</p></td>
<td><p>确保设备电量充足，建议电量&gt;30%</p></td>
</tr>
<tr class="row-odd"><td><p>信号问题</p></td>
<td><p>设备距离过远，导致信号不稳定</p></td>
<td><p>保持设备与手机距离在1米以内</p></td>
</tr>
<tr class="row-even"><td><p>设备异常</p></td>
<td><p>设备异常，导致设备重启</p></td>
<td><p>检查设备状态，必要时重启设备</p></td>
</tr>
<tr class="row-odd"><td><p>手机蓝牙</p></td>
<td><p>手机蓝牙异常，导致连接断开</p></td>
<td><p>重启手机蓝牙或重启手机</p></td>
</tr>
<tr class="row-even"><td><p>文件问题</p></td>
<td><p>升级文件损坏，导致校验失败</p></td>
<td><p>重新下载升级文件，检查文件完整性</p></td>
</tr>
</tbody>
</table>
</section>
<section id="id13">
<h4>升级过程中断开的可能原因<a class="headerlink" href="#id13" title="Link to this heading"></a></h4>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>原因类别</p></th>
<th class="head"><p>具体原因</p></th>
<th class="head"><p>解决方案</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>设备电量</p></td>
<td><p>设备电量不足，导致设备关机</p></td>
<td><p>确保设备电量充足，建议电量&gt;30%</p></td>
</tr>
<tr class="row-odd"><td><p>信号问题</p></td>
<td><p>设备距离过远，导致信号不稳定</p></td>
<td><p>保持设备与手机距离在1米以内</p></td>
</tr>
<tr class="row-even"><td><p>设备异常</p></td>
<td><p>设备异常，导致设备重启</p></td>
<td><p>检查设备状态，必要时重启设备</p></td>
</tr>
<tr class="row-odd"><td><p>手机蓝牙</p></td>
<td><p>手机蓝牙异常，导致连接断开</p></td>
<td><p>重启手机蓝牙或重启手机</p></td>
</tr>
<tr class="row-even"><td><p>文件问题</p></td>
<td><p>升级文件损坏，导致升级失败</p></td>
<td><p>重新下载升级文件，检查文件完整性</p></td>
</tr>
<tr class="row-odd"><td><p>存储空间</p></td>
<td><p>设备存储空间不足，导致升级失败</p></td>
<td><p>清理设备存储空间或使用更小的升级包</p></td>
</tr>
</tbody>
</table>
</section>
<section id="id14">
<h4>日志分析方法<a class="headerlink" href="#id14" title="Link to this heading"></a></h4>
<p>这种情况常见于传输过程中断导致无法继续升级，解决方式：一般这种异常，都属于数据传输过程中，命令不回复/超时导致的，可分析log中的SN以及命令号状态错误信息，具体可参考上文的日志分析。</p>
</section>
</section>
<section id="id15">
<h3>2.7.5. 升级过程中可能出现的命令错误<a class="headerlink" href="#id15" title="Link to this heading"></a></h3>
<section id="id16">
<h4>命令错误类型分析<a class="headerlink" href="#id16" title="Link to this heading"></a></h4>
<section id="opcode-0xe2">
<h5>Opcode: 0xe2 - 发送升级文件头部偏移信息给设备的命令<a class="headerlink" href="#opcode-0xe2" title="Link to this heading"></a></h5>
<p><strong>命令结构：</strong></p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>字段</p></th>
<th class="head"><p>说明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>status</p></td>
<td><p>命令状态</p></td>
</tr>
<tr class="row-odd"><td><p>opCode</p></td>
<td><p>操作码</p></td>
</tr>
<tr class="row-even"><td><p>sn</p></td>
<td><p>序列号</p></td>
</tr>
<tr class="row-odd"><td><p>result</p></td>
<td><p>结果</p></td>
</tr>
</tbody>
</table>
<p><strong>返回结果说明：</strong></p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>结果码</p></th>
<th class="head"><p>含义</p></th>
<th class="head"><p>解决方案</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0x00</p></td>
<td><p>可以升级</p></td>
<td><p>正常，继续升级流程</p></td>
</tr>
<tr class="row-odd"><td><p>0x01</p></td>
<td><p>设备电量过低</p></td>
<td><p>充电后再进行升级</p></td>
</tr>
<tr class="row-even"><td><p>0x02</p></td>
<td><p>升级固件信息错误</p></td>
<td><p>检查升级文件是否正确</p></td>
</tr>
<tr class="row-odd"><td><p>0x03</p></td>
<td><p>升级文件版本一致</p></td>
<td><p>确认是否需要升级，或使用新版本文件</p></td>
</tr>
<tr class="row-even"><td><p>0x04</p></td>
<td><p>TWS未连接</p></td>
<td><p>确保TWS设备已正确连接</p></td>
</tr>
<tr class="row-odd"><td><p>0x05</p></td>
<td><p>耳机未在充电仓</p></td>
<td><p>将耳机放入充电仓后再升级</p></td>
</tr>
</tbody>
</table>
</section>
<section id="opcode-0xe3">
<h5>Opcode: 0xe3 - 进入升级模式请求命令<a class="headerlink" href="#opcode-0xe3" title="Link to this heading"></a></h5>
<p><strong>命令结构：</strong></p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>字段</p></th>
<th class="head"><p>说明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>status</p></td>
<td><p>命令状态</p></td>
</tr>
<tr class="row-odd"><td><p>param</p></td>
<td><p>参数</p></td>
</tr>
</tbody>
</table>
<p><strong>返回结果说明：</strong></p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>结果码</p></th>
<th class="head"><p>含义</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0x00</p></td>
<td><p>可以升级</p></td>
</tr>
<tr class="row-odd"><td><p>0x01</p></td>
<td><p>不可以升级</p></td>
</tr>
</tbody>
</table>
</section>
<section id="opcode-0xe4">
<h5>Opcode: 0xe4 - 退出升级模式<a class="headerlink" href="#opcode-0xe4" title="Link to this heading"></a></h5>
<p><strong>说明：</strong> 收/发退出升级模式，这时候要分析是哪一端发起的退出升级模式</p>
</section>
<section id="opcode-0xe5">
<h5>Opcode: 0xe5 - 设备请求升级文件数据<a class="headerlink" href="#opcode-0xe5" title="Link to this heading"></a></h5>
<p><strong>说明：</strong> 设备主动请求升级文件的数据，SDK端收到后，按照请求大小发送给设备</p>
</section>
<section id="opcode-0xe6">
<h5>Opcode: 0xe6 - 读取设备升级状态指令<a class="headerlink" href="#opcode-0xe6" title="Link to this heading"></a></h5>
<p><strong>说明：</strong> SDK端发起，设备会在param里回复状态信息（1Byte）</p>
<p><strong>升级状态码：</strong></p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>状态码</p></th>
<th class="head"><p>含义</p></th>
<th class="head"><p>说明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0x00</p></td>
<td><p>升级完成</p></td>
<td><p>升级成功完成</p></td>
</tr>
<tr class="row-odd"><td><p>0x01</p></td>
<td><p>升级数据校验出错</p></td>
<td><p>数据完整性校验失败</p></td>
</tr>
<tr class="row-even"><td><p>0x02</p></td>
<td><p>升级失败</p></td>
<td><p>一般性升级失败</p></td>
</tr>
<tr class="row-odd"><td><p>0x03</p></td>
<td><p>加密key不匹配</p></td>
<td><p>加密密钥验证失败</p></td>
</tr>
<tr class="row-even"><td><p>0x04</p></td>
<td><p>升级文件出错</p></td>
<td><p>升级文件格式或内容错误</p></td>
</tr>
<tr class="row-odd"><td><p>0x05</p></td>
<td><p>uboot不匹配</p></td>
<td><p>引导程序版本不兼容</p></td>
</tr>
<tr class="row-even"><td><p>0x06</p></td>
<td><p>升级过程中出现长度错误</p></td>
<td><p>数据长度校验失败</p></td>
</tr>
<tr class="row-odd"><td><p>0x07</p></td>
<td><p>出现flash读写错误</p></td>
<td><p>存储器读写异常</p></td>
</tr>
<tr class="row-even"><td><p>0x08</p></td>
<td><p>升级过程中指令超时</p></td>
<td><p>命令执行超时</p></td>
</tr>
<tr class="row-odd"><td><p>0x09</p></td>
<td><p>相同升级文件</p></td>
<td><p>升级文件版本相同</p></td>
</tr>
<tr class="row-even"><td><p>0x80</p></td>
<td><p>下载boot loader完成</p></td>
<td><p>引导程序下载完成</p></td>
</tr>
</tbody>
</table>
<p><strong>注意：</strong> 升级完成后退出升级模式，0x80只有下载loader完成才回复，其余为错误码</p>
</section>
<section id="opcode-0xe7">
<h5>Opcode: 0xe7 - 强制设备重启指令<a class="headerlink" href="#opcode-0xe7" title="Link to this heading"></a></h5>
<p><strong>说明：</strong> SDK发起的设备重启命令</p>
</section>
<section id="opcode-0x0b">
<h5>Opcode: 0x0b - 切换通信方式<a class="headerlink" href="#opcode-0x0b" title="Link to this heading"></a></h5>
<p><strong>说明：</strong> SDK主动让固件切换通信方式</p>
</section>
<section id="opcode-0xe8-app">
<h5>Opcode: 0xe8 - 通知APP升级内容长度<a class="headerlink" href="#opcode-0xe8-app" title="Link to this heading"></a></h5>
<p><strong>说明：</strong> 通知APP升级内容长度，由设备端发起</p>
</section>
</section>
</section>
<hr class="docutils" />
<section id="id17">
<h3>2.7.6. OTA 后台升级问题<a class="headerlink" href="#id17" title="Link to this heading"></a></h3>
<section id="ios">
<h4>iOS 蓝牙后台权限配置<a class="headerlink" href="#ios" title="Link to this heading"></a></h4>
<p>iOS 的蓝牙后台权限需要在工程中手动配置。要设置应用程序在后台使用蓝牙的权限，需要在项目的 Info.plist 文件中添加相应的权限描述。</p>
</section>
<section id="id18">
<h4>配置步骤<a class="headerlink" href="#id18" title="Link to this heading"></a></h4>
<ol class="arabic">
<li><p><strong>打开 Xcode 项目</strong></p></li>
<li><p><strong>编辑 Info.plist 文件</strong></p>
<ul class="simple">
<li><p>找到项目导航栏中的 Info.plist 文件</p></li>
<li><p>右键选择 Open As -&gt; Source Code，以便直接编辑 XML</p></li>
</ul>
</li>
<li><p><strong>添加后台模式权限</strong>
在 <code class="docutils literal notranslate"><span class="pre">&lt;dict&gt;</span></code> 标签中添加以下键值对：</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;key&gt;</span>UIBackgroundModes<span class="nt">&lt;/key&gt;</span>
<span class="nt">&lt;array&gt;</span>
<span class="w">    </span><span class="nt">&lt;string&gt;</span>bluetooth-central<span class="nt">&lt;/string&gt;</span>
<span class="nt">&lt;/array&gt;</span>
</pre></div>
</div>
<p>这个键值对告诉系统你的应用程序需要在后台使用 CoreBluetooth 框架。</p>
</li>
<li><p><strong>请求蓝牙后台传输权限</strong>
在应用程序启动时，使用以下代码请求蓝牙后台传输权限：</p>
<div class="highlight-objc notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="w"> </span><span class="p">([</span><span class="n">_centralManager</span><span class="w"> </span><span class="n">respondsToSelector</span><span class="o">:</span><span class="k">@selector</span><span class="p">(</span><span class="n">scanForPeripheralsWithServices</span><span class="o">:</span><span class="n">options</span><span class="o">:</span><span class="p">)])</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">[</span><span class="n">_centralManager</span><span class="w"> </span><span class="n">scanForPeripheralsWithServices</span><span class="o">:</span><span class="nb">nil</span><span class="w"> </span>
<span class="w">                                            </span><span class="nl">options</span><span class="p">:</span><span class="l">@{</span><span class="n">CBCentralManagerScanOptionAllowDuplicatesKey</span><span class="o">:</span><span class="l">@(</span><span class="nb">YES</span><span class="l">)}</span><span class="p">];</span>
<span class="p">}</span>
</pre></div>
</div>
<p>这将启动蓝牙扫描，并在后台继续扫描外围设备。</p>
</li>
<li><p><strong>配置 Capabilities</strong>
在项目的 Capabilities 面板中确保开启了 Background Modes，并勾选了 Uses Bluetooth LE Accessories 选项。</p></li>
</ol>
</section>
<section id="id19">
<h4>注意事项<a class="headerlink" href="#id19" title="Link to this heading"></a></h4>
<p>完成以上步骤后，你的应用程序就可以在后台使用蓝牙了。请注意：</p>
<ul class="simple">
<li><p>后台蓝牙传输会消耗较多的电量</p></li>
<li><p>请根据实际需求谨慎使用</p></li>
<li><p>仅推荐双备份版本的设备升级使用此功能</p></li>
</ul>
</section>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="页脚">
        <a href="debug.html" class="btn btn-neutral float-left" title="测试调试" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> 上一页</a>
        <a href="contactUs.html" class="btn btn-neutral float-right" title="开源社区" accesskey="n" rel="next">下一页 <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2024, Zhuhai Jieli Technology.,Ltd。
      <span class="lastupdated">最后更新于 10月 13, 2025.
      </span></p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>